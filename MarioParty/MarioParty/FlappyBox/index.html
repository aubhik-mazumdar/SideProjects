<!DOCTYPE html>
<html>
<head>

	<title>FlappyBlock</title>

	<script type="text/javascript" src="../Canvas/canvas.js"></script>
	<script type="text/javascript">
		let bird, keyDown, started, score = 0, speed = 2;

		const pipes = [];
		const powerUps = [];
		const powerUpTypes = [() => {
			speed += 2;
		}, () => {
			speed -= 2;
		}, () => {
			score *= 2;
		}];

		function setup() {
			canvas = new Canvas(document.getElementsByTagName('canvas')[0], 400, 600);
			bird = new Bird();
			pipes.push(new Pipe());

			document.addEventListener('keydown', evt => {
				started = true;

				if (!keyDown) {
					keyDown = true;
					bird.up();
				}
			});

			document.addEventListener('keyup', evt => {
				keyDown = false;
			});
		}

		function draw() {
			canvas.background();

			if (started) {
				pipes.forEach((object, key) => {
					object.show();
					object.update();

					if (object.throughCenter(bird))
						score += 5;

					if (object.hits(bird))
						death();

					if (object.offscreen())
						pipes.remove(object);
				});

				if (frameCount % 100 == 0)
					pipes.push(new Pipe());

				bird.update();
			}

			if (bird.edges())
				death();

			if (frameCount % 500 == 0) {
				const center = pipes.random().centerOfGap();

				powerUps.push(new PowerUp(center.x, center.y, powerUpTypes.random()));
			}

			bird.show();
		}

		function death() {
			console.log('DEATH');
		}

		class Bird {
			constructor() {
				this.y = center.y;
				this.x = 64;
				this.size = 32;

				this.lift = -15;
				this.velocity = 0;
				this.gravity = 0.6;
			}

			edges() {
				if (this.y + this.size * 2 > canvas.height)
					return true;
				else if (this.y - this.size * 2 < 0)
					return true;
				else
					return false;
			}

			show() {
				canvas.circle(this.x, this.y, this.size, 'white', true);
			}

			up() {
				this.velocity += this.lift;
			}

			update() {
				this.velocity += this.gravity;
				this.velocity *= 0.9;
				this.y += this.velocity;

				if (this.y > canvas.height - this.size) {
					this.y = canvas.height - this.size;
					this.velocity = 0;
				}

				if (this.y < this.size) {
					this.y = this.size;
					this.velocity = 0;
				}
			}
		}

		class Pipe {
			constructor() {
				this.top = Math.random() * (center.y - 20);
				this.bottom = Math.random() * (center.y - 20);
				this.x = canvas.width;
				this.w = 20;
			}

			centerOfGap() {
				const pos = this.getTwoPipePos();

				// canvas.rect(this.x, pos[0].h, this.w, canvas.height - (pos[0].h + pos[1].h), 'blue');
				const middleCenter = {
					x: this.x,
					y: (canvas.height - (pos[0].h + pos[1].h)) / 2 + pos[0].h
				}

				return middleCenter;
			}

			throughCenter(bird) {
				const pos = this.getTwoPipePos();
				const gap = {
					x: this.x,
					y: pos[0].h,
					w: this.w,
					h: canvas.height - (pos[0].h + pos[1].h)
				}

				const circle = {
					x: bird.x,
					y: bird.y,
					r: bird.size
				}

				return Math.rectCircleColliding(circle, gap);
			}

			getTwoPipePos() {
				return [
				{
					x: this.x,
					y: 0,
					w: this.w,
					h: this.top
				},
				{
					x: this.x,
					y: canvas.height - this.bottom,
					w: this.w,
					h: this.bottom
				}
				];
			}

			hits(bird) {
				const arr = [];
				const twoPos = this.getTwoPipePos();
				const circle = {
					x: bird.x,
					y: bird.y,
					r: bird.size
				};

				arr.push(Math.rectCircleColliding(circle, twoPos[0]));
				arr.push(Math.rectCircleColliding(circle, twoPos[1]));

				return arr.some(val => {return val});
			}

			show() {
				canvas.rect(this.x, 0, this.w, this.top, 'purple');
				canvas.rect(this.x, canvas.height - this.bottom, this.w, this.bottom, 'purple');
			}

			update() {
			}

			offscreen() {
				if (this.x < -this.w)
					return true;
				else
					return false;
			}
		}

		class PowerUp {
			constructor(x, y, type) {

			}
		}
	</script>

</head>
<body>

	<canvas></canvas>

</body>
</html>