<!DOCTYPE html>
<html>
<head>

	<title>SineGame</title>

	<style type="text/css">
		body {
			margin: 0;
			width: 100%;
			height: 100%;
			display: flex;
			position: absolute;
			align-items: center;
			justify-content: center;
		}
	</style>

	<script type="text/javascript" src="Canvas/canvas.js"></script>
	<script type="text/javascript">
		let player;
		let score = 0;
		let moveTime = 10;
		let moving = false;
		let started = false;

		const trail = [];
		const obstacles = [];
		const colors = ["#1abc9c", "#2ecc71", "#3498db", "#9b59b6", "#16a085", "#27ae60", "#2980b9", "#8e44ad", "#f1c40f", "#e67e22", "#e74c3c", "#f39c12", "#d35400", "#c0392b"];

		function setup() {
			canvas = new Canvas(document.getElementById('canvas'), 300, 500);
			player = new Player(canvas);

			// Keyboard
			window.addEventListener('keydown', evt => {
				moveTime = 10;
				moving = true;
			});

			window.addEventListener('keyup', evt => {
				moving = false;
				started = true;
			});

			// Touch
			window.addEventListener('touchstart', evt => {
				moveTime = 10;
				moving = true;
			});

			window.addEventListener('touchend', evt => {
				moving = false;
				started = true;
			});

			obstacles.push(new Obstacle(canvas, Math.randomBetween(30, 60), 3, center.x + Math.randomBetween(-canvas.width / 3, canvas.width / 3)));
		}

		function draw() {
			canvas.background('#CCCCCC');

			trail.forEach((object, key) => {
				if (object.y > canvas.height) trail.splice(key, 1);
				else {
					if (moving) object.y += 2;
				}
			});

			canvas.connect(trail, 4, '#2196f3');

			if (!moving) trail.length = 0;

			player.update();
			player.draw();

			obstacles.forEach((object, key) => {
				object.draw();

				if (started) {
					if (moving) {
						object.move();
						score += 0.05;
					} else moveTime -= 0.02;
				}

				// Check off-screen
				if (object.pos.y - object.size > canvas.height) obstacles.splice(key, 1);

				// Check collision
				const circle = {
					x: player.pos.x,
					y: player.pos.y,
					r: player.size
				};

				const rect = {
					x: object.pos.x,
					y: object.pos.y,
					w: object.size,
					h: object.size
				};

				if (Math.rectCircleColliding(circle, rect)) gameOver();

				// Check if passed tpast a certain point and spawn a new
				if (object.pos.y >= Math.randomBetween(-10, 10) + ((canvas.height / 3)) && object.hasSpawned == false) {
					object.hasSpawned = true;
					obstacles.push(new Obstacle(canvas, Math.randomBetween(30, 60), 3, center.x + Math.randomBetween(-canvas.width / 3, canvas.width / 3)));
				}
			});

			if (moveTime <= 0) gameOver();

			canvas.background('rgba(255, 255, 255, 0.5)');
			const color = (Math.round(moveTime) <= 5) ? 'red' : 'white';
			canvas.text(Math.round(moveTime), 10, 25, color, 20, 'left');
			canvas.text(Math.round(score), canvas.width - 10, 25, 'white', 20, 'right');
		}

		function gameOver() {
			noLoop();
			canvas.text('YOU LOST', center.x, center.y, 'red', 50);
			canvas.text('SCORE: ' + Math.round(score), center.x, center.y + 50, 'white', 30);
		}

		class Player {
			constructor(canvas) {
				this.count = 0;
				this.size = 10;
				this.speed = 0.03;
				this.canvas = canvas;
				this.pos = new Vector(center.x, center.y + canvas.height / 10);
			}

			update() {
				this.pos.x = Math.floor((this.canvas.width / 2) + (Math.sin(this.count)) * (this.canvas.width / 2 - 30));
				this.count += this.speed;

				if (frameCount % 5 == 0 && moving) trail.push(this.pos.copy());
			}

			draw() {
				this.canvas.circle(this.pos.x, this.pos.y, this.size, '#2196f3', true);
			}
		}

		class Obstacle {
			constructor(canvas, size, speed, xPos) {
				this.size = size;
				this.speed = speed;
				this.canvas = canvas;
				this.hasSpawned = false;
				this.color = colors.random();
				this.pos = new Vector(xPos, -this.size);
			}

			move() {
				this.pos.y += this.speed;
			}

			draw() {
				this.canvas.square(this.pos.x, this.pos.y, this.size, this.color, false);
			}
		}

		Array.prototype.random = function() {
			return this[Math.floor(Math.random() * this.length)];
		}
	</script>

</head>
<body>

	<canvas id="canvas"></canvas>

</body>
</html>
